-- üîê –¢–†–ò–ì–ì–ï–† –î–õ–Ø –ó–ê–©–ò–¢–´ –°–ò–°–¢–ï–ú–ù–´–• –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô

-- –ó–∞–ø—Ä–µ—â–∞–µ—Ç —É–¥–∞–ª–µ–Ω–∏–µ –∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å ID 0 (sys) –∏ 1
-- –û—Å—Ç–∞–ª—å–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (—Å–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è, email, —Ç–µ–ª–µ—Ñ–æ–Ω–∞, —Å—Ç–∞—Ç—É—Å–∞) —Ä–∞–∑—Ä–µ—à–µ–Ω—ã

-- –§—É–Ω–∫—Ü–∏—è —Ç—Ä–∏–≥–≥–µ—Ä–∞
CREATE OR REPLACE FUNCTION protect_system_users()
RETURNS TRIGGER AS $$
BEGIN
    -- –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–ø–µ—Ä–∞—Ü–∏—é DELETE
    IF TG_OP = 'DELETE' THEN
        -- –ó–∞–ø—Ä–µ—â–∞–µ–º —É–¥–∞–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        IF OLD._id IN (0, 1) THEN
            RAISE EXCEPTION '–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å ID %', OLD._id;
        END IF;
        RETURN OLD;
    END IF;
    
    -- –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–ø–µ—Ä–∞—Ü–∏—é UPDATE
    IF TG_OP = 'UPDATE' THEN
        -- –ó–∞–ø—Ä–µ—â–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ ID (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
        IF OLD._id != NEW._id THEN
            RAISE EXCEPTION '–ù–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è';
        END IF;
        
        -- –î–ª—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∑–∞–ø—Ä–µ—â–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ª–æ–≥–∏–Ω–∞ –∏ –∏–º–µ–Ω–∏
        IF OLD._id IN (0, 1) THEN
            -- –ó–∞–ø—Ä–µ—â–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ª–æ–≥–∏–Ω–∞
            IF OLD._login != NEW._login THEN
                RAISE EXCEPTION '–ù–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å –ª–æ–≥–∏–Ω —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å ID %', OLD._id;
            END IF;
            
            -- –ó–∞–ø—Ä–µ—â–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∏–º–µ–Ω–∏
            IF OLD._name != NEW._name THEN
                RAISE EXCEPTION '–ù–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å –∏–º—è —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å ID %', OLD._id;
            END IF;
        END IF;
        
        RETURN NEW;
    END IF;
    
    -- –î–ª—è INSERT –Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- –°–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä–∞ –Ω–∞ —Ç–∞–±–ª–∏—Ü–µ _users
DROP TRIGGER IF EXISTS tr_protect_system_users ON _users;
CREATE TRIGGER tr_protect_system_users
    BEFORE UPDATE OR DELETE ON _users
    FOR EACH ROW
    EXECUTE FUNCTION protect_system_users();

-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ —Ç—Ä–∏–≥–≥–µ—Ä—É
COMMENT ON FUNCTION protect_system_users() IS '–ó–∞—â–∏—â–∞–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (ID 0, 1) –æ—Ç —É–¥–∞–ª–µ–Ω–∏—è –∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è';
COMMENT ON TRIGGER tr_protect_system_users ON _users IS '–¢—Ä–∏–≥–≥–µ—Ä –∑–∞—â–∏—Ç—ã —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ—Ç —É–¥–∞–ª–µ–Ω–∏—è –∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è –ª–æ–≥–∏–Ω–∞/–∏–º–µ–Ω–∏';

-- –¢–µ—Å—Ç–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç—Ä–∏–≥–≥–µ—Ä–∞:
/*
-- ‚úÖ –≠—Ç–æ –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å (—Å–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è sys –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è):
UPDATE _users SET _password = 'new_hash' WHERE _id = 0;

-- ‚úÖ –≠—Ç–æ –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å (—Å–º–µ–Ω–∞ email sys –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è):
UPDATE _users SET _email = 'sys@newdomain.com' WHERE _id = 0;

-- ‚ùå –≠—Ç–æ –¥–æ–ª–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å –æ—à–∏–±–∫—É (—Å–º–µ–Ω–∞ –ª–æ–≥–∏–Ω–∞ sys –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è):
UPDATE _users SET _login = 'system' WHERE _id = 0;

-- ‚ùå –≠—Ç–æ –¥–æ–ª–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å –æ—à–∏–±–∫—É (—Å–º–µ–Ω–∞ –∏–º–µ–Ω–∏ sys –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è):
UPDATE _users SET _name = 'System Administrator' WHERE _id = 0;

-- ‚ùå –≠—Ç–æ –¥–æ–ª–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å –æ—à–∏–±–∫—É (—É–¥–∞–ª–µ–Ω–∏–µ sys –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è):
DELETE FROM _users WHERE _id = 0;

-- ‚ùå –≠—Ç–æ –¥–æ–ª–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å –æ—à–∏–±–∫—É (—É–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å ID 1):
DELETE FROM _users WHERE _id = 1;

-- ‚úÖ –≠—Ç–æ –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å (–æ–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å):
UPDATE _users SET _login = 'new_login', _name = 'New Name' WHERE _id = 100;
DELETE FROM _users WHERE _id = 100;
*/
